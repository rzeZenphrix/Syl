<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Module Configuration - SYL</title>
  <link rel="stylesheet" href="/css/theme.css">
  <style>
    body {
      background: #23272a;
      color: #fff;
      font-family: 'Inter', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 700px;
      margin: 3em auto 0 auto;
      background: #2c2f33;
      border-radius: 12px;
      box-shadow: 0 2px 16px #0008;
      padding: 2.5em 2em 2em 2em;
      text-align: center;
    }
    .module-header {
      font-size: 1.5em;
      font-weight: 700;
      margin-bottom: 0.2em;
    }
    .module-sub {
      color: #aaa;
      font-size: 1.1em;
      margin-bottom: 2em;
    }
    .back-btn {
      position: fixed;
      top: 1.2em;
      left: 1.2em;
      background: #36393f;
      color: #fff;
      border: none;
      border-radius: 50px;
      font-size: 0.98em;
      font-weight: 500;
      padding: 0.45em 1.1em;
      cursor: pointer;
      box-shadow: 0 1px 6px #0003;
      z-index: 1000;
      opacity: 0.85;
      transition: background 0.18s, opacity 0.18s;
    }
    .back-btn:hover {
      background: #5865f2;
      opacity: 1;
    }
    .logout-btn {
      position: fixed;
      top: 1.2em;
      right: 1.2em;
      background: #36393f;
      color: #fff;
      border: none;
      border-radius: 50px;
      font-size: 0.98em;
      font-weight: 500;
      padding: 0.45em 1.1em;
      cursor: pointer;
      box-shadow: 0 1px 6px #0003;
      z-index: 1000;
      opacity: 0.85;
      transition: background 0.18s, opacity 0.18s;
    }
    .logout-btn:hover {
      background: #e74c3c;
      opacity: 1;
    }
    .boost-section-title {
      font-size: 1.1em;
      font-weight: 700;
      margin-bottom: 1.2em;
      color: #fff;
      border-bottom: 1px solid #444;
      padding-bottom: 0.8em;
    }
    .boost-label {
      display: block;
      margin: 1.1em 0 0.3em 0;
      font-weight: 500;
      text-align: left;
    }
    .boost-channel-select {
      width: 100%;
      padding: 0.7em 1em;
      border-radius: 6px;
      border: 1px solid #444;
      background: #181a1b;
      color: #fff;
      font-size: 1em;
      margin-bottom: 1em;
      cursor: pointer;
      transition: border 0.18s;
    }
    .boost-channel-select:focus {
      border: 1.5px solid #5865f2;
      outline: none;
    }
    .boost-test-btn {
      display: block;
      width: 100%;
      padding: 0.7em 0;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      background: #43b581;
      color: #fff;
      transition: background 0.18s, transform 0.18s;
      box-shadow: 0 1px 6px #43b58144;
    }
    .boost-test-btn:hover {
      background: #2ecc71;
      transform: scale(1.04);
    }
    .boost-color {
      margin: 0.5em 0 1em 0;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 8px;
      background: #181a1b;
      cursor: pointer;
      box-shadow: 0 1px 6px #0003;
      vertical-align: middle;
    }
    .boost-textarea {
      width: 100%;
      min-height: 70px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #181a1b;
      color: #fff;
      font-size: 1em;
      padding: 0.7em;
      margin-bottom: 0.5em;
      resize: vertical;
      font-family: inherit;
      transition: border 0.18s;
    }
    .boost-textarea:focus {
      border: 1.5px solid #5865f2;
      outline: none;
    }
    .boost-preview {
      background: #181a1b;
      border-radius: 8px;
      padding: 1em 1.2em;
      margin: 1.2em 0 0.7em 0;
      color: #fff;
      text-align: left;
      border-left: 6px solid var(--boost-color, #5865f2);
      min-height: 40px;
      font-size: 1.05em;
      box-shadow: 0 1px 6px #0002;
      transition: border-color 0.18s;
    }
    .boost-save {
      margin-top: 1.2em;
      background: #5865f2;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      font-weight: 600;
      padding: 0.7em 2.2em;
      cursor: pointer;
      transition: background 0.18s, transform 0.18s;
      box-shadow: 0 1px 6px #5865f244;
    }
    .boost-save:hover {
      background: #4752c4;
      transform: scale(1.04);
    }
    .boost-error {
      color: #ff5555;
      margin-top: 0.7em;
      font-size: 0.98em;
    }
    .emoji-picker {
      cursor: pointer;
      font-size: 1.2em;
      margin-left: 0.2em;
    }
    .error {
      color: #ff5555;
      margin-top: 2em;
      font-size: 1.1em;
    }
  </style>
  <script src="auth.js"></script>
  <script>requireAuth();</script>
</head>
<body>
  <button class="back-btn" id="backBtn">‚Üê Back</button>
  <button class="logout-btn" onclick="logout()">Logout</button>
  <div class="container">
    <div class="module-header" id="moduleHeader">Loading...</div>
    <div class="module-sub" id="moduleSub"></div>
    <div id="error" class="error"></div>
    <div id="boostConfig" style="display:none;"></div>
  </div>
  <script>
    // --- Get guild and module from URL ---
    function getParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    const guildId = getParam('guild');
    const moduleKey = getParam('module');
    const moduleInfo = {
      boost: {
        title: 'Boost Messages',
        desc: 'Send custom messages when someone boosts your server.'
      },
      backup: {
        title: 'Backup & Restore',
        desc: 'Export and restore server roles, channels, categories, and permissions.'
      }
    };
    document.getElementById('backBtn').onclick = function() {
      window.location.href = `dashboard.html?guild=${guildId}`;
    };
    if (!guildId || !moduleKey || !moduleInfo[moduleKey]) {
      document.getElementById('moduleHeader').textContent = 'Invalid module or server.';
      document.getElementById('error').textContent = 'Please return to the server dashboard.';
    } else {
      document.getElementById('moduleHeader').textContent = moduleInfo[moduleKey].title;
      document.getElementById('moduleSub').textContent = moduleInfo[moduleKey].desc;
      if (moduleKey === 'boost') showBoostConfig();
      if (moduleKey === 'backup') showBackupConfig();
      if (moduleKey === 'setup') showSetupConfig();
    }
    function authHeaders() {
      const t = localStorage.getItem('asylum_token');
      return t ? { Authorization: 'Bearer ' + t } : {};
    }
    function showBackupConfig() {
      const root = document.getElementById('boostConfig');
      root.style.display = '';
      root.innerHTML = `
        <div class="boost-section-title">Backup</div>
        <p style="color:#b0b8c1;text-align:left;">Create a full backup of your server's roles, channels, categories, and permissions. Only users with Manage Server can perform backups.</p>
        <button id="downloadBackup" class="boost-test-btn">Download Backup</button>
        <div class="boost-section-title" style="margin-top:2em;">Restore</div>
        <p style="color:#b0b8c1;text-align:left;">Restore from a previously exported backup file. This will create roles/channels. Only users with Manage Server can restore.</p>
        <input type="file" id="backupFile" accept="application/json" style="margin:0.6em 0 1em 0;" />
        <button id="restoreBtn" class="boost-save">Restore</button>
        <div id="backupMsg" class="boost-error"></div>
      `;
      const msg = document.getElementById('backupMsg');
      document.getElementById('downloadBackup').onclick = async () => {
        msg.style.color = '#aaa';
        msg.textContent = 'Generating backup...';
        try {
          const res = await fetch(`/api/guild/${guildId}/backup`, { headers: authHeaders() });
          if (!res.ok) {
            const e = await res.json().catch(()=>({}));
            msg.style.color = '#ff5555';
            msg.textContent = e.error || 'Failed to generate backup';
            return;
          }
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `guild-${guildId}-backup.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          msg.style.color = '#43b581';
          msg.textContent = 'Backup downloaded.';
          setTimeout(()=> msg.textContent = '', 1500);
        } catch {
          msg.style.color = '#ff5555';
          msg.textContent = 'Failed to generate backup';
        }
      };
      document.getElementById('restoreBtn').onclick = async () => {
        const fileInput = document.getElementById('backupFile');
        if (!fileInput.files || !fileInput.files[0]) {
          msg.style.color = '#ff5555';
          msg.textContent = 'Please choose a backup file.';
          return;
        }
        try {
          const text = await fileInput.files[0].text();
          const payload = JSON.parse(text);
          msg.style.color = '#aaa';
          msg.textContent = 'Restoring...';
          const res = await fetch(`/api/guild/${guildId}/restore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...authHeaders() },
            body: JSON.stringify(payload)
          });
          const out = await res.json().catch(()=>({}));
          if (!res.ok || !out.success) {
            msg.style.color = '#ff5555';
            msg.textContent = out.error || 'Restore failed';
            return;
          }
          msg.style.color = '#43b581';
          msg.textContent = 'Restore started. Check your server.';
          setTimeout(()=> msg.textContent = '', 2000);
        } catch (e) {
          msg.style.color = '#ff5555';
          msg.textContent = 'Invalid or unreadable backup file.';
        }
      };
    }
    function showBoostConfig() {
      const root = document.getElementById('boostConfig');
      root.style.display = '';
      root.innerHTML = `
        <form id="boostForm" autocomplete="off">
          <div class="boost-section-title">General Settings</div>
          <label class="boost-label" for="boostChannel">Channel</label>
          <select id="boostChannel" class="boost-channel-select"><option>Loading...</option></select>
          <button type="button" class="boost-test-btn" id="boostTestBtn" disabled>Test message</button>
          <label class="boost-label" style="margin-top:1.2em;">Embed <input type="checkbox" id="boostEmbedToggle" style="margin-left:0.7em;transform:scale(1.3);vertical-align:middle;"></label>
          <div class="boost-section-title" style="margin-top:2em;">Content & Style</div>
          <label class="boost-label" for="boostColor">Embed Color</label>
          <input type="color" id="boostColor" class="boost-color" value="#5865f2">
          <label class="boost-label" for="boostMsg">Boost Message</label>
          <textarea id="boostMsg" class="boost-textarea" maxlength="300" placeholder="Thank you for boosting, {user}!" required></textarea>
          <div style="margin-bottom:0.5em; text-align:left; font-size:0.97em; color:#aaa;">
            Placeholders: <code>{user}</code> <code>{server}</code> <code>{count}</code> <code>{boosters}</code>
            <span class="emoji-picker" id="emojiPicker">üéâ</span>
          </div>
          <div class="boost-preview" id="boostPreview" style="--boost-color: #5865f2;">Thank you for boosting, {user}!</div>
          <button type="submit" class="boost-save">Save</button>
          <div class="boost-error" id="boostError"></div>
        </form>
      `;
      let channels = [];
      let channelsLoaded = false;
      const boostMsg = document.getElementById('boostMsg');
      const boostColor = document.getElementById('boostColor');
      const boostPreview = document.getElementById('boostPreview');
      const boostForm = document.getElementById('boostForm');
      const boostError = document.getElementById('boostError');
      const emojiPicker = document.getElementById('emojiPicker');
      const boostChannel = document.getElementById('boostChannel');
      const boostTestBtn = document.getElementById('boostTestBtn');
      const boostEmbedToggle = document.getElementById('boostEmbedToggle');
      // Emoji picker
      const emojis = ['üéâ','‚ú®','üíé','üöÄ','üåü','ü•≥','üíñ','üî•','üéÅ','ü¶Ñ','‚≠ê'];
      emojiPicker.onclick = function() {
        const menu = document.createElement('div');
        menu.style.position = 'absolute';
        menu.style.background = '#23272a';
        menu.style.border = '1px solid #444';
        menu.style.borderRadius = '8px';
        menu.style.padding = '0.5em 0.7em';
        menu.style.top = (emojiPicker.getBoundingClientRect().bottom + window.scrollY + 5) + 'px';
        menu.style.left = (emojiPicker.getBoundingClientRect().left + window.scrollX - 10) + 'px';
        menu.style.zIndex = 3000;
        menu.innerHTML = emojis.map(e => `<span style=\"font-size:1.3em;cursor:pointer;padding:0 0.2em;\">${e}</span>`).join('');
        document.body.appendChild(menu);
        menu.onclick = function(ev) {
          if (ev.target.textContent) {
            boostMsg.value += ev.target.textContent;
            boostMsg.dispatchEvent(new Event('input'));
            document.body.removeChild(menu);
          }
        };
        document.addEventListener('click', function handler(ev) {
          if (!menu.contains(ev.target) && ev.target !== emojiPicker) {
            document.body.removeChild(menu);
            document.removeEventListener('click', handler);
          }
        });
      };
      // Live preview
      function updatePreview() {
        boostPreview.textContent = boostMsg.value || 'Thank you for boosting, {user}!';
        boostPreview.style.setProperty('--boost-color', boostColor.value);
        boostPreview.style.background = boostEmbedToggle.checked ? '#181a1b' : 'transparent';
        boostPreview.style.borderLeft = boostEmbedToggle.checked ? `6px solid ${boostColor.value}` : 'none';
      }
      boostMsg.addEventListener('input', updatePreview);
      boostColor.addEventListener('input', updatePreview);
      boostEmbedToggle.addEventListener('change', updatePreview);
      updatePreview();
      // Load config
      boostError.textContent = 'Loading...';
      boostError.style.color = '#aaa';
      fetch(`/api/guild/${guildId}/boost-message`).then(r => r.json()).then(cfg => {
        boostMsg.value = cfg.message || '';
        boostColor.value = cfg.color || '#5865f2';
        updatePreview();
        boostError.textContent = '';
      }).catch(() => {
        boostError.textContent = 'Failed to load config.';
        boostError.style.color = '#ff5555';
      });
      // Fetch channels
      boostChannel.innerHTML = '<option>Loading...</option>';
      boostTestBtn.disabled = true;
      fetch(`/api/guild/${guildId}/channels`).then(r => {
        if (r.status === 404) {
          boostChannel.innerHTML = '<option>Bot not in server or cannot access channels</option>';
          boostTestBtn.disabled = true;
          boostError.textContent = 'Bot is not in this server or cannot access channels.';
          boostError.style.color = '#ff5555';
          return;
        }
        return r.json();
      }).then(list => {
        if (!list) return;
        channels = list;
        channelsLoaded = true;
        boostChannel.innerHTML = channels.map(c => `<option value=\"${c.id}\">${c.name}</option>`).join('');
        boostTestBtn.disabled = false;
      }).catch(() => {
        boostChannel.innerHTML = '<option>Error loading channels</option>';
        boostTestBtn.disabled = true;
      });
      // Save
      boostForm.onsubmit = function(e) {
        e.preventDefault();
        boostError.textContent = '';
        boostError.style.color = '#ff5555';
        if (!boostMsg.value.trim()) {
          boostError.textContent = 'Boost message cannot be empty.';
          return;
        }
        if (boostMsg.value.length > 300) {
          boostError.textContent = 'Boost message is too long (max 300 chars).';
          return;
        }
        if (!/^#[0-9a-fA-F]{6}$/.test(boostColor.value)) {
          boostError.textContent = 'Invalid color.';
          return;
        }
        boostError.textContent = 'Saving...';
        boostError.style.color = '#aaa';
        fetch(`/api/guild/${guildId}/boost-message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: boostMsg.value, color: boostColor.value })
        }).then(r => r.json()).then(resp => {
          if (resp.success) {
            boostError.style.color = '#43b581';
            boostError.textContent = 'Saved!';
            setTimeout(() => boostError.textContent = '', 1200);
          } else {
            boostError.textContent = resp.error || 'Failed to save.';
            boostError.style.color = '#ff5555';
          }
        }).catch(() => {
          boostError.textContent = 'Failed to save.';
          boostError.style.color = '#ff5555';
        });
      };
      // Test message
      boostTestBtn.onclick = function() {
        if (!channelsLoaded) return;
        boostTestBtn.disabled = true;
        boostError.style.color = '#aaa';
        boostError.textContent = 'Sending test message...';
        fetch(`/api/guild/${guildId}/boost-test`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: boostMsg.value,
            color: boostColor.value,
            channelId: boostChannel.value,
            embed: boostEmbedToggle.checked
          })
        }).then(r => r.json()).then(resp => {
          if (resp.success) {
            boostError.style.color = '#43b581';
            boostError.textContent = 'Test message sent!';
          } else {
            boostError.style.color = '#ff5555';
            boostError.textContent = resp.error || 'Failed to send test message.';
          }
        }).catch(() => {
          boostError.style.color = '#ff5555';
          boostError.textContent = 'Failed to send test message.';
        }).finally(() => {
          boostTestBtn.disabled = false;
          setTimeout(() => boostError.textContent = '', 1800);
        });
      };
    }
    function showSetupConfig() {
      const root = document.getElementById('boostConfig');
      root.style.display = '';
      root.innerHTML = `
        <div class="boost-section-title">Setup</div>
        <p class="subtle" style="text-align:left;">Use Setup to configure admin roles, prefixes, and key bot options. Only users with appropriate permissions can modify settings.</p>
        <div class="card" style="text-align:left;">
          <div class="mb-2"><b>How to use</b></div>
          <ul style="color:var(--muted); line-height:1.8; padding-left:1.2em;">
            <li>Run <code>/setup</code> to set admin and extra roles and disable commands.</li>
            <li>Run <code>/logchannel</code> to set a moderation log channel.</li>
            <li>Run <code>/prefix</code> to set a custom command prefix.</li>
            <li>Run <code>/disable-commands</code> to manage which commands are available.</li>
          </ul>
        </div>
      `;
    }
  </script>
</body>
</html> 