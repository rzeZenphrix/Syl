<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SYL Bot - Module Configuration</title>
  <link rel="stylesheet" href="/css/theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Module page specific styles */
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-family);
      margin: 0;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-xl);
    }

    .header {
      display: flex;
      align-items: center;
      gap: var(--space-lg);
      margin-bottom: var(--space-2xl);
      padding-bottom: var(--space-xl);
      border-bottom: 1px solid var(--border-primary);
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      transition: all var(--transition-normal);
    }

    .back-btn:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-secondary);
      color: var(--text-primary);
      transform: translateX(-2px);
    }

    .module-info {
      flex: 1;
    }

    .module-title {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
    }

    .module-description {
      color: var(--text-secondary);
      font-size: var(--font-size-base);
    }

    .module-icon {
      width: 64px;
      height: 64px;
      border-radius: var(--radius-lg);
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .module-icon svg {
      width: 32px;
      height: 32px;
      color: var(--accent-primary);
    }

    /* Configuration sections */
    .config-section {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-primary);
      padding: var(--space-xl);
      margin-bottom: var(--space-xl);
      transition: all var(--transition-normal);
    }

    .config-section:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-secondary);
      box-shadow: var(--shadow-md);
    }

    .section-title {
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-md);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .section-description {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-lg);
      line-height: 1.6;
    }

    /* Form elements */
    .form-group {
      margin-bottom: var(--space-lg);
    }

    .form-label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
      font-size: var(--font-size-sm);
    }

    .form-input {
      width: 100%;
      padding: var(--space-md);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: inherit;
      font-size: var(--font-size-sm);
      transition: all var(--transition-normal);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(108, 127, 255, 0.1);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }

    /* Backup specific styles */
    .backup-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--space-lg);
      margin-top: var(--space-lg);
    }

    .backup-card {
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-primary);
      padding: var(--space-xl);
      text-align: center;
      transition: all var(--transition-normal);
    }

    .backup-card:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-secondary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .backup-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-lg);
      background: var(--accent-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--space-md);
    }

    .backup-icon svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    .backup-title {
      font-size: var(--font-size-lg);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
    }

    .backup-description {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-lg);
      line-height: 1.5;
    }

    /* File upload */
    .file-upload {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-lg);
      background: var(--bg-tertiary);
      border: 2px dashed var(--border-primary);
      border-radius: var(--radius-lg);
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-normal);
    }

    .file-upload-label:hover {
      border-color: var(--accent-primary);
      background: var(--bg-card-hover);
      color: var(--text-primary);
    }

    .file-upload-label.dragover {
      border-color: var(--accent-primary);
      background: rgba(108, 127, 255, 0.1);
    }

    /* Progress bar */
    .progress-container {
      margin-top: var(--space-lg);
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      overflow: hidden;
      margin-bottom: var(--space-sm);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      border-radius: var(--radius-sm);
      transition: width var(--transition-slow);
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    .progress-text {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      text-align: center;
    }

    .form-help {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-top: var(--space-xs);
    }

    .form-checkbox {
      margin-right: var(--space-sm);
      width: 16px;
      height: 16px;
      accent-color: var(--accent-primary);
    }

    /* Status messages */
    .status-message {
      padding: var(--space-md);
      border-radius: var(--radius-md);
      margin-top: var(--space-md);
      font-weight: 500;
      display: none;
    }

    .status-success {
      background: rgba(67, 181, 129, 0.1);
      border: 1px solid var(--accent-success);
      color: var(--accent-success);
    }

    .status-error {
      background: rgba(255, 85, 85, 0.1);
      border: 1px solid var(--accent-danger);
      color: var(--accent-danger);
    }

    .status-info {
      background: rgba(108, 127, 255, 0.1);
      border: 1px solid var(--accent-primary);
      color: var(--accent-primary);
    }

    /* Welcome/Goodbye specific */
    .message-preview {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin-top: var(--space-md);
      font-size: var(--font-size-sm);
      line-height: 1.6;
      color: var(--text-secondary);
    }

    .message-preview.embed {
      border-left: 4px solid var(--accent-primary);
    }

    /* Setup specific */
    .setup-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--space-lg);
      margin-top: var(--space-lg);
    }

    .setup-item {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      text-align: center;
      transition: all var(--transition-normal);
    }

    .setup-item:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-secondary);
      transform: translateY(-2px);
    }

    .setup-icon {
      width: 32px;
      height: 32px;
      margin: 0 auto var(--space-md);
      color: var(--accent-primary);
    }

    .setup-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
    }

    .setup-description {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: var(--space-lg);
      }

      .header {
        flex-direction: column;
        text-align: center;
        gap: var(--space-md);
      }

      .backup-actions {
        grid-template-columns: 1fr;
      }

      .setup-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Animations */
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .animate-slide-in {
      animation: slideInUp 0.5s ease-out;
    }

    .animate-fade-in {
      animation: fadeInScale 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <a href="dashboard.html?guild=${guildId}" class="back-btn" id="backBtn">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 8H3M8 15l-7-7 7-7"/>
        </svg>
        Back to Dashboard
      </a>
      
      <div class="module-info">
        <h1 class="module-title" id="moduleTitle">Module Configuration</h1>
        <p class="module-description" id="moduleDescription">Configure your module settings</p>
      </div>
      
      <div class="module-icon" id="moduleIcon">
        <svg fill="none" stroke="currentColor" stroke-width="2">
          <rect x="4" y="4" width="16" height="16" rx="2"/>
          <path d="M8 12h8M12 8v8"/>
        </svg>
      </div>
    </div>

    <!-- Configuration Content -->
    <div id="configContent">
      <!-- Content will be dynamically loaded based on module type -->
    </div>
  </div>

  <script src="auth.js"></script>
  <script>
    // Authentication check
    requireAuth();

    // Get URL parameters
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        guild: params.get('guild'),
        module: params.get('module')
      };
    }

    const { guild: guildId, module: moduleKey } = getUrlParams();

    // Module configurations
    const moduleConfigs = {
      welcome: {
        title: 'Welcome Messages',
        description: 'Configure welcome messages for new members joining your server',
        icon: `<svg fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 20c1.5 2 4.5 2 6 0l8-12"/>
          <path d="M8 20V8a4 4 0 0 1 8 0v12"/>
        </svg>`,
        content: `
          <div class="config-section animate-slide-in">
            <h2 class="section-title">
              <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 20c1.5 2 4.5 2 6 0l8-12"/>
                <path d="M8 20V8a4 4 0 0 1 8 0v12"/>
              </svg>
              Welcome Message Settings
            </h2>
            <p class="section-description">Configure the message sent when new members join your server.</p>
            
            <div class="form-group">
              <label class="form-label">Welcome Channel</label>
              <select class="form-input form-select" id="welcomeChannel">
                <option value="">Select a channel...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Welcome Message</label>
              <textarea class="form-input form-textarea" id="welcomeMessage" placeholder="Welcome {user} to {server}! You are member #{count}." rows="4"></textarea>
              <div class="form-help">Available variables: {user}, {server}, {count}, {mention}</div>
              <div class="message-preview" id="welcomePreview">
                Welcome @username to Server Name! You are member #123.
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Welcome Role</label>
              <select class="form-input form-select" id="welcomeRole">
                <option value="">No role assigned</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="welcomeEnabled" class="form-checkbox">
                Enable Welcome Messages
              </label>
            </div>
            
            <button class="btn btn-primary" onclick="saveWelcomeConfig()">Save Welcome Settings</button>
          </div>
        `
      },

      tickets: {
        title: 'Ticketing System',
        description: 'Configure your support ticket system',
        icon: `<svg fill="none" stroke="currentColor" stroke-width="2">
          <rect x="6" y="10" width="20" height="12" rx="4"/>
          <path d="M10 16h12"/>
        </svg>`,
        content: `
          <div class="config-section animate-slide-in">
            <h2 class="section-title">
              <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="6" y="10" width="20" height="12" rx="4"/>
                <path d="M10 16h12"/>
              </svg>
              Ticket Setup
            </h2>
            <p class="section-description">Configure your ticket system settings and permissions.</p>
            
            <div class="form-group">
              <label class="form-label">Ticket Category</label>
              <select class="form-input form-select" id="ticketCategory">
                <option value="">Select a category...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Support Role</label>
              <select class="form-input form-select" id="supportRole">
                <option value="">Select a role...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Ticket Channel Name</label>
              <input type="text" class="form-input" id="ticketChannelName" placeholder="ticket-{user}" value="ticket-{user}">
            </div>
            
            <button class="btn btn-primary" onclick="saveTicketConfig()">Save Ticket Settings</button>
          </div>
        `
      },
      goodbye: {
        title: 'Goodbye Messages',
        description: 'Configure goodbye messages for members leaving your server',
        icon: `<svg fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 20c1.5 2 4.5 2 6 0l8-12"/>
          <path d="M8 20V8a4 4 0 0 1 8 0v12"/>
        </svg>`,
        content: `
          <div class="config-section animate-slide-in">
            <h2 class="section-title">
              <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 20c1.5 2 4.5 2 6 0l8-12"/>
                <path d="M8 20V8a4 4 0 0 1 8 0v12"/>
              </svg>
              Goodbye Message Settings
            </h2>
            <p class="section-description">Configure the message sent when members leave your server.</p>
            
            <div class="form-group">
              <label class="form-label">Goodbye Channel</label>
              <select class="form-input form-select" id="goodbyeChannel">
                <option value="">Select a channel...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Goodbye Message</label>
              <textarea class="form-input form-textarea" id="goodbyeMessage" placeholder="Goodbye {user}! We'll miss you." rows="4"></textarea>
              <div class="form-help">Available variables: {user}, {server}</div>
              <div class="message-preview" id="goodbyePreview">
                Goodbye @username! We'll miss you.
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="goodbyeEnabled" class="form-checkbox">
                Enable Goodbye Messages
              </label>
            </div>
            
            <button class="btn btn-primary" onclick="saveGoodbyeConfig()">Save Goodbye Settings</button>
          </div>
        `
      },

      backup: {
        title: 'Server Backup',
        description: 'Backup and restore your server structure',
        icon: `<svg fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10a6 6 0 1 0-9 5M3 12a13 13 0 1 0 5-10"/>
        </svg>`,
        content: `
          <div class="backup-actions">
            <div class="backup-card animate-fade-in">
              <div class="backup-icon">
                <svg fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7,10 12,15 17,10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
              </div>
              <h3 class="backup-title">Download Backup</h3>
              <p class="backup-description">Create a complete backup of your server's roles, channels, categories, and permissions.</p>
              <button class="btn btn-primary" onclick="downloadBackup()">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7,10 12,15 17,10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Download Backup
              </button>
            </div>

            <div class="backup-card animate-fade-in">
              <div class="backup-icon">
                <svg fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17,8 12,3 7,8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
              </div>
              <h3 class="backup-title">Restore Backup</h3>
              <p class="backup-description">Restore your server from a previously exported backup file.</p>
              
              <div class="file-upload">
                <input type="file" id="backupFile" accept=".json" onchange="handleFileSelect(event)">
                <label for="backupFile" class="file-upload-label" id="fileUploadLabel">
                  <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17,8 12,3 7,8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                  Choose backup file or drag here
                </label>
              </div>
              
              <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">Preparing restore...</div>
              </div>
              
              <button class="btn btn-success" onclick="restoreBackup()" id="restoreBtn" disabled>
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17,8 12,3 7,8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Restore Server
              </button>
            </div>
          </div>

          <div class="status-message" id="statusMessage"></div>
        `
      },

      setup: {
        title: 'Server Setup',
        description: 'Configure server roles, channels, and bot preferences',
        icon: `<svg fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v4M20 2v4M4 10h24"/>
          <rect x="6" y="12" width="20" height="16" rx="3"/>
        </svg>`,
        content: `
          <div class="config-section animate-slide-in">
            <h2 class="section-title">
              <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v4M20 2v4M4 10h24"/>
                <rect x="6" y="12" width="20" height="16" rx="3"/>
              </svg>
              Quick Setup
            </h2>
            <p class="section-description">Use these commands to quickly configure your server structure.</p>
            
            <div class="setup-grid">
              <div class="setup-item">
                <svg class="setup-icon" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <div class="setup-title">Roles Setup</div>
                <div class="setup-description">Use <code>/setup roles</code> to create basic server roles</div>
              </div>
              
              <div class="setup-item">
                <svg class="setup-icon" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <line x1="9" y1="9" x2="15" y2="9"/>
                  <line x1="9" y1="12" x2="15" y2="12"/>
                  <line x1="9" y1="15" x2="15" y2="15"/>
                </svg>
                <div class="setup-title">Channels Setup</div>
                <div class="setup-description">Use <code>/setup channels</code> to create basic channels</div>
              </div>
              
              <div class="setup-item">
                <svg class="setup-icon" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"/>
                  <path d="M12 1v6m0 6v6"/>
                  <path d="M21 12h-6m-6 0H3"/>
                </svg>
                <div class="setup-title">Permissions</div>
                <div class="setup-description">Use <code>/setup permissions</code> to configure role permissions</div>
              </div>
              
              <div class="setup-item">
                <svg class="setup-icon" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14,2 14,8 20,8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                  <polyline points="10,9 9,9 8,9"/>
                </svg>
                <div class="setup-title">Bot Settings</div>
                <div class="setup-description">Use <code>/setup bot</code> to configure bot preferences</div>
              </div>
            </div>
          </div>
        `
      }
    };

    // Initialize page
    function initPage() {
      if (!guildId || !moduleKey) {
        showError('Missing guild ID or module key');
        return;
      }

      const config = moduleConfigs[moduleKey];
      if (!config) {
        showError('Unknown module');
        return;
      }

      // Update page content with null checks
      const moduleTitle = document.getElementById('moduleTitle');
      const moduleDescription = document.getElementById('moduleDescription');
      const moduleIcon = document.getElementById('moduleIcon');
      const configContent = document.getElementById('configContent');
      
      if (moduleTitle) moduleTitle.textContent = config.title;
      if (moduleDescription) moduleDescription.textContent = config.description;
      if (moduleIcon) moduleIcon.innerHTML = config.icon;
      if (configContent) configContent.innerHTML = config.content;

      // Load module-specific data
      loadModuleData();
    }

    // Load module-specific data
    async function loadModuleData() {
      try {
        // Load channels and roles for dropdowns
        const [channelsRes, rolesRes] = await Promise.all([
          fetch(`/api/guild/${guildId}/channels`),
          fetch(`/api/guild/${guildId}/roles`)
        ]);

        if (channelsRes.ok) {
          const channels = await channelsRes.json();
          populateChannelDropdowns(channels);
        }

        if (rolesRes.ok) {
          const roles = await rolesRes.json();
          populateRoleDropdowns(roles);
        }

        // Load existing configuration
        if (moduleKey === 'welcome') {
          loadWelcomeConfig();
        } else if (moduleKey === 'goodbye') {
          loadGoodbyeConfig();
        } else if (moduleKey === 'tickets') {
          loadTicketConfig();
        }
      } catch (error) {
        console.error('Failed to load module data:', error);
        showError('Failed to load module data');
      }
    }

    // Populate channel dropdowns
    function populateChannelDropdowns(channels) {
      const channelDropdowns = document.querySelectorAll('select[id$="Channel"]');
      channelDropdowns.forEach(dropdown => {
        dropdown.innerHTML = '<option value="">Select a channel...</option>';
        channels.forEach(channel => {
          const option = document.createElement('option');
          option.value = channel.id;
          option.textContent = `#${channel.name}`;
          dropdown.appendChild(option);
        });
      });
    }

    // Populate role dropdowns
    function populateRoleDropdowns(roles) {
      const roleDropdowns = document.querySelectorAll('select[id$="Role"]');
      roleDropdowns.forEach(dropdown => {
        dropdown.innerHTML = '<option value="">No role assigned</option>';
        roles.forEach(role => {
          const option = document.createElement('option');
          option.value = role.id;
          option.textContent = `@${role.name}`;
          dropdown.appendChild(option);
        });
      });
    }

    // Backup functions
    let selectedBackupFile = null;

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file && file.type === 'application/json') {
        selectedBackupFile = file;
        document.getElementById('restoreBtn').disabled = false;
        const fileUploadLabel = document.getElementById('fileUploadLabel');
        if (fileUploadLabel) fileUploadLabel.textContent = file.name;
        showStatus('Backup file selected: ' + file.name, 'success');
      } else {
        showError('Please select a valid JSON backup file');
      }
    }

    async function downloadBackup() {
      try {
        showStatus('Generating backup...', 'info');
        
        const response = await fetch(`/api/guild/${guildId}/backup`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('asylum_token')}` }
        });

        if (!response.ok) {
          throw new Error('Failed to generate backup');
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `guild-${guildId}-backup-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        showStatus('Backup downloaded successfully!', 'success');
      } catch (error) {
        console.error('Backup download failed:', error);
        showError('Failed to download backup: ' + error.message);
      }
    }

    async function restoreBackup() {
      if (!selectedBackupFile) {
        showError('Please select a backup file first');
        return;
      }

      try {
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const restoreBtn = document.getElementById('restoreBtn');

        progressContainer.style.display = 'block';
        restoreBtn.disabled = true;

        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress > 90) progress = 90;
          progressFill.style.width = progress + '%';
          if (progressText) progressText.textContent = `Restoring... ${Math.round(progress)}%`;
        }, 200);

        // Read and parse backup file
        const text = await selectedBackupFile.text();
        const backupData = JSON.parse(text);

        // Send restore request
        const response = await fetch(`/api/guild/${guildId}/restore`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('asylum_token')}`
          },
          body: JSON.stringify(backupData)
        });

        clearInterval(progressInterval);

        if (!response.ok) {
          throw new Error('Restore failed');
        }

        const result = await response.json();
        
        if (result.success) {
          progressFill.style.width = '100%';
          if (progressText) progressText.textContent = 'Restore completed!';
          showStatus('Server restored successfully!', 'success');
        } else {
          throw new Error(result.error || 'Restore failed');
        }
      } catch (error) {
        console.error('Restore failed:', error);
        showError('Failed to restore backup: ' + error.message);
      } finally {
        document.getElementById('restoreBtn').disabled = false;
        setTimeout(() => {
          document.getElementById('progressContainer').style.display = 'none';
          document.getElementById('progressFill').style.width = '0%';
        }, 3000);
      }
    }

    // Welcome/Goodbye functions
    async function loadWelcomeConfig() {
      try {
        const response = await fetch(`/api/guild/${guildId}/welcome-config`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('asylum_token')}`
          }
        });
        
        if (response.ok) {
          const config = await response.json();
          
          const channelSelect = document.getElementById('welcomeChannel');
          const messageTextarea = document.getElementById('welcomeMessage');
          const roleSelect = document.getElementById('welcomeRole');
          const enabledCheckbox = document.getElementById('welcomeEnabled');
          
          if (channelSelect) channelSelect.value = config.channelId || '';
          if (messageTextarea) messageTextarea.value = config.message || '';
          if (roleSelect) roleSelect.value = config.roleId || '';
          if (enabledCheckbox) enabledCheckbox.checked = config.enabled || false;
        }
      } catch (error) {
        console.error('Failed to load welcome config:', error);
      }
    }

    async function loadGoodbyeConfig() {
      try {
        const response = await fetch(`/api/guild/${guildId}/goodbye-config`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('asylum_token')}`
          }
        });
        
        if (response.ok) {
          const config = await response.json();
          
          const channelSelect = document.getElementById('goodbyeChannel');
          const messageTextarea = document.getElementById('goodbyeMessage');
          const enabledCheckbox = document.getElementById('goodbyeEnabled');
          
          if (channelSelect) channelSelect.value = config.channelId || '';
          if (messageTextarea) messageTextarea.value = config.message || '';
          if (enabledCheckbox) enabledCheckbox.checked = config.enabled || false;
        }
      } catch (error) {
        console.error('Failed to load goodbye config:', error);
      }
    }

    async function saveWelcomeConfig() {
      try {
        const channelId = document.getElementById('welcomeChannel').value;
        const message = document.getElementById('welcomeMessage').value;
        const roleId = document.getElementById('welcomeRole').value;
        const enabled = document.getElementById('welcomeEnabled').checked;
        
        const response = await fetch(`/api/guild/${guildId}/welcome-config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('asylum_token')}`
          },
          body: JSON.stringify({ channelId, message, roleId, enabled })
        });
        
        if (!response.ok) {
          throw new Error('Failed to save welcome configuration');
        }
        
        showStatus('Welcome settings saved!', 'success');
      } catch (error) {
        console.error('Failed to save welcome config:', error);
        showError('Failed to save welcome settings: ' + error.message);
      }
    }

    async function saveGoodbyeConfig() {
      try {
        const channelId = document.getElementById('goodbyeChannel').value;
        const message = document.getElementById('goodbyeMessage').value;
        const enabled = document.getElementById('goodbyeEnabled').checked;
        
        const response = await fetch(`/api/guild/${guildId}/goodbye-config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('asylum_token')}`
          },
          body: JSON.stringify({ channelId, message, enabled })
        });
        
        if (!response.ok) {
          throw new Error('Failed to save goodbye configuration');
        }
        
        showStatus('Goodbye settings saved!', 'success');
      } catch (error) {
        console.error('Failed to save goodbye config:', error);
        showError('Failed to save goodbye settings: ' + error.message);
      }
    }

    // Ticket functions
    function loadTicketConfig() {
      // Load existing ticket configuration
    }

    function saveTicketConfig() {
      // Save ticket configuration
      showStatus('Ticket settings saved!', 'success');
    }

    // Utility functions
    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      if (!statusDiv) {
        console.warn('Status message element not found');
        return;
      }
      statusDiv.textContent = message;
      statusDiv.className = `status-message status-${type}`;
      statusDiv.style.display = 'block';
      
      setTimeout(() => {
        if (statusDiv) {
          statusDiv.style.display = 'none';
        }
      }, 5000);
    }

    function showError(message) {
      showStatus(message, 'error');
    }

    // Initialize page when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Update back button href with guild ID
      const backBtn = document.getElementById('backBtn');
      if (backBtn && guildId) {
        backBtn.href = `dashboard.html?guild=${guildId}`;
      }
      
      initPage();
    });

    // File drag and drop
    document.addEventListener('DOMContentLoaded', () => {
      const fileUploadLabel = document.getElementById('fileUploadLabel');
      if (fileUploadLabel) {
        fileUploadLabel.addEventListener('dragover', (e) => {
          e.preventDefault();
          fileUploadLabel.classList.add('dragover');
        });

        fileUploadLabel.addEventListener('dragleave', () => {
          fileUploadLabel.classList.remove('dragover');
        });

        fileUploadLabel.addEventListener('drop', (e) => {
          e.preventDefault();
          fileUploadLabel.classList.remove('dragover');
          const file = e.dataTransfer.files[0];
          if (file) {
            document.getElementById('backupFile').files = e.dataTransfer.files;
            handleFileSelect({ target: { files: e.dataTransfer.files } });
          }
        });
      }
    });
  </script>
</body>
</html> 