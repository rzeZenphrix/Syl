<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="/css/theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Dashboard-specific styles */
    body {
      display: flex;
      background: var(--bg-primary);
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 280px;
      height: 100vh;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-primary);
      display: flex;
      flex-direction: column;
      z-index: var(--z-fixed);
      transition: transform var(--transition-normal);
    }

    .sidebar-header {
      padding: var(--space-xl);
      border-bottom: 1px solid var(--border-primary);
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .server-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-lg);
      background: var(--bg-tertiary);
      object-fit: cover;
      border: 2px solid var(--accent-primary);
      box-shadow: var(--shadow-glow);
    }

    .server-info {
      flex: 1;
      min-width: 0;
    }

    .server-name {
      font-size: var(--font-size-lg);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-xs);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .server-status {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-success);
      animation: pulse 2s infinite;
    }

    .sidebar-nav {
      flex: 1;
      padding: var(--space-lg);
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      transition: all var(--transition-normal);
      cursor: pointer;
    }

    .nav-item:hover {
      background: var(--bg-sidebar-hover);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--accent-primary);
      color: white;
    }

    .nav-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    /* Main Content */
    .main {
      flex: 1;
      margin-left: 280px;
      min-height: 100vh;
      background: var(--bg-primary);
    }

    .main-header {
      padding: var(--space-xl);
      border-bottom: 1px solid var(--border-primary);
      background: var(--bg-secondary);
    }

    .page-title {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
    }

    .page-subtitle {
      color: var(--text-secondary);
      font-size: var(--font-size-base);
    }

    .main-content {
      padding: var(--space-xl);
    }

    /* Dashboard Cards */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--space-xl);
      margin-bottom: var(--space-2xl);
    }

    .stats-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-primary);
      padding: var(--space-xl);
      transition: all var(--transition-normal);
    }

    .stats-card:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-secondary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .stats-value {
      font-size: var(--font-size-3xl);
      font-weight: 700;
      color: var(--accent-primary);
      margin-bottom: var(--space-xs);
    }

    .stats-label {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      font-weight: 500;
    }

    /* Modules Header */
    .modules-header {
      margin-bottom: var(--space-2xl);
    }

    .modules-header h2 {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
    }

    .modules-header p {
      color: var(--text-secondary);
      font-size: var(--font-size-base);
    }

    /* Module Grid */
    .module-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: var(--space-xl);
    }

    .module-card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-primary);
      padding: var(--space-xl);
      transition: all var(--transition-normal);
      position: relative;
      overflow: hidden;
    }

    .module-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      transform: scaleX(0);
      transition: transform var(--transition-normal);
    }

    .module-card:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-secondary);
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
    }

    .module-card:hover::before {
      transform: scaleX(1);
    }

    .module-card.enabled {
      border-color: var(--accent-success);
    }

    .module-card.enabled::before {
      background: linear-gradient(90deg, var(--accent-success), var(--accent-secondary));
      transform: scaleX(1);
    }

    .module-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }

    .module-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-lg);
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .module-icon svg {
      width: 24px;
      height: 24px;
      color: var(--accent-primary);
    }

    .module-info {
      flex: 1;
      min-width: 0;
    }

    .module-title {
      font-size: var(--font-size-lg);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-xs);
    }

    .module-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .module-description {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      line-height: 1.5;
      margin-bottom: var(--space-lg);
    }

    .module-actions {
      display: flex;
      gap: var(--space-md);
    }

    .module-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-md);
      border: none;
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
      position: relative;
      overflow: hidden;
    }

    .module-btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), #5a6bff);
      color: white;
    }

    .module-btn-primary:hover {
      background: linear-gradient(135deg, #5a6bff, var(--accent-primary));
      transform: translateY(-1px);
      box-shadow: var(--shadow-md), var(--shadow-glow);
    }

    .module-btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-primary);
    }

    .module-btn-secondary:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-secondary);
      transform: translateY(-1px);
    }

    .module-btn-danger {
      background: linear-gradient(135deg, var(--accent-danger), #e74c3c);
      color: white;
    }

    .module-btn-danger:hover {
      background: linear-gradient(135deg, #e74c3c, var(--accent-danger));
      transform: translateY(-1px);
      box-shadow: var(--shadow-md), 0 0 20px rgba(255, 85, 85, 0.3);
    }

    /* Mobile Sidebar */
    .sidebar-toggle {
      display: none;
      position: fixed;
      top: var(--space-md);
      left: var(--space-md);
      z-index: var(--z-fixed);
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: var(--space-sm);
      cursor: pointer;
      transition: all var(--transition-normal);
    }

    .sidebar-toggle:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-secondary);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main {
        margin-left: 0;
      }

      .sidebar-toggle {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .module-grid {
        grid-template-columns: 1fr;
      }

      .main-header,
      .main-content {
        padding: var(--space-lg);
      }
    }

    /* Loading Animation */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: var(--z-modal);
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border-primary);
      border-top: 4px solid var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Success Animation */
    @keyframes successPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .success-animation {
      animation: successPulse 0.6s ease-out;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: var(--z-modal);
      animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-primary);
      max-width: 480px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: slideInScale 0.3s ease-out;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-lg) var(--space-xl);
      border-bottom: 1px solid var(--border-primary);
    }

    .modal-header h3 {
      margin: 0;
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: var(--space-sm);
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }

    .modal-close:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .modal-body {
      padding: var(--space-xl);
      text-align: center;
    }

    .modal-icon {
      margin-bottom: var(--space-lg);
      color: var(--accent-warning);
    }

    .modal-body p {
      margin: 0 0 var(--space-md) 0;
      color: var(--text-primary);
      font-size: var(--font-size-base);
      line-height: 1.6;
    }

    .modal-warning {
      color: var(--text-secondary) !important;
      font-size: var(--font-size-sm) !important;
    }

    .modal-footer {
      display: flex;
      gap: var(--space-md);
      padding: var(--space-lg) var(--space-xl);
      border-top: 1px solid var(--border-primary);
      justify-content: flex-end;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideInScale {
      from { 
        opacity: 0; 
        transform: scale(0.9) translateY(-20px); 
      }
      to { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Sidebar Toggle -->
  <button class="sidebar-toggle" id="sidebarToggle">
    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 12h18M3 6h18M3 18h18"/>
    </svg>
  </button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="" alt="Server icon" class="server-icon" id="serverIcon">
      <div class="server-info">
        <div class="server-name" id="serverName">Dashboard</div>
        <div class="server-status">
          <div class="status-indicator" id="statusIndicator"></div>
          <span id="serverStatus">Online</span>
        </div>
      </div>
    </div>
    
    <nav class="sidebar-nav">
      <a class="nav-item active" data-section="dashboard">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="9" cy="9" r="2"/>
          <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
        </svg>
        Dashboard
      </a>
      <a class="nav-item" data-section="modules">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="4" y="4" width="16" height="16" rx="2"/>
          <path d="M8 12h8M12 8v8"/>
        </svg>
        Modules
      </a>
      <a class="nav-item" data-section="help">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
          <path d="M12 17h.01"/>
        </svg>
        Help
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main">
    <header class="main-header">
      <h1 class="page-title" id="pageTitle">Dashboard</h1>
      <p class="page-subtitle" id="pageSubtitle">Welcome to your server dashboard</p>
    </header>

    <main class="main-content" id="mainContent">
      <!-- Dashboard Section -->
      <div id="dashboardSection">
        <div class="dashboard-grid">
          <div class="stats-card">
            <div class="stats-value" id="memberCount">-</div>
            <div class="stats-label">Members</div>
          </div>
          <div class="stats-card">
            <div class="stats-value" id="channelCount">-</div>
            <div class="stats-label">Channels</div>
          </div>
          <div class="stats-card">
            <div class="stats-value" id="roleCount">-</div>
            <div class="stats-label">Roles</div>
          </div>
          <div class="stats-card">
            <div class="stats-value" id="moduleCount">-</div>
            <div class="stats-label">Active Modules</div>
          </div>
        </div>

        <div class="module-grid" id="moduleGrid">
          <!-- Modules will be dynamically loaded here -->
        </div>
      </div>

      <!-- Modules Section -->
      <div id="modulesSection" style="display: none;">
        <div class="modules-header">
          <h2>Module Configuration</h2>
          <p>Enable and configure modules for your server. Only enabled modules will be active.</p>
        </div>
        
        <div class="module-grid" id="modulesGrid">
          <!-- Modules will be dynamically loaded here -->
        </div>
      </div>

      <!-- Help Section -->
      <div id="helpSection" style="display: none;">
        <div class="card">
          <h2>Help & Support</h2>
          <p>Find answers to common questions about using the Dashboard.</p>
          
          <div class="mt-lg">
            <h3>Getting Started</h3>
            <ul>
              <li><strong>How do I configure modules?</strong><br>
                Click the "Configure" button on any module card to access its settings.</li>
              <li><strong>Why don't I see all modules?</strong><br>
                Only modules that are currently implemented in the bot are shown.</li>
              <li><strong>Who can use the dashboard?</strong><br>
                Only users with "Manage Server" permission can configure modules.</li>
            </ul>
          </div>

          <div class="mt-lg">
            <h3>Available Modules</h3>
            <ul>
              <li><strong>Welcome Messages:</strong> Send custom welcome messages when new members join</li>
              <li><strong>Goodbye Messages:</strong> Send custom goodbye messages when members leave</li>
              <li><strong>Tickets:</strong> Create a support ticket system for your server</li>
              <li><strong>Backup:</strong> Backup and restore your server structure</li>
              <li><strong>Setup:</strong> Configure server roles, channels, and bot preferences</li>
              <li><strong>Moderation:</strong> Advanced moderation tools including warnings, mutes, and bans</li>
              <li><strong>Utility:</strong> Helpful utility commands for server management</li>
            </ul>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-spinner"></div>
  </div>

  <!-- Module Disable Modal -->
  <div id="disableModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Disable Module</h3>
        <button class="modal-close" onclick="closeDisableModal()">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-icon">
          <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
        </div>
        <p id="disableModalText">Are you sure you want to disable this module?</p>
        <p class="modal-warning">This will disable all functionality for this module until you re-enable it.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDisableModal()">Cancel</button>
        <button class="btn btn-danger" id="confirmDisableBtn">Disable Module</button>
      </div>
    </div>
  </div>

  <script src="auth.js"></script>
  <script>
    // Authentication check
    requireAuth();

    // Global variables
    let currentUser = null;
    let currentGuild = null;
    let moduleStates = {};

    // Get guild ID from URL
    function getGuildId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('guild');
    }

    const guildId = getGuildId();

    // Available modules (only those actually implemented)
    const availableModules = [
      {
        key: 'welcome',
        title: 'Welcome Messages',
        description: 'Send custom welcome messages when new members join your server',
        icon: `<svg fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 20c1.5 2 4.5 2 6 0l8-12"/>
          <path d="M8 20V8a4 4 0 0 1 8 0v12"/>
        </svg>`,
        badge: 'Core',
        badgeType: 'core'
      },
      {
        key: 'goodbye',
        title: 'Goodbye Messages',
        description: 'Send custom goodbye messages when members leave your server',
        icon: `<svg fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 20c1.5 2 4.5 2 6 0l8-12"/>
          <path d="M8 20V8a4 4 0 0 1 8 0v12"/>
        </svg>`,
        badge: 'Core',
        badgeType: 'core'
      },
      {
        key: 'tickets',
        title: 'Ticketing System',
        description: 'Create a support ticket system for your server members',
        icon: `<svg fill="none" stroke="currentColor" stroke-width="2">
          <rect x="6" y="10" width="20" height="12" rx="4"/>
          <path d="M10 16h12"/>
        </svg>`,
        badge: 'Core',
        badgeType: 'core'
      },
      {
        key: 'backup',
        title: 'Server Backup',
        description: 'Backup and restore your server roles, channels, and permissions',
        icon: `<svg fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10a6 6 0 1 0-9 5M3 12a13 13 0 1 0 5-10"/>
        </svg>`,
        badge: 'New',
        badgeType: 'new'
      },
      {
        key: 'setup',
        title: 'Server Setup',
        description: 'Configure server roles, channels, and bot preferences',
        icon: `<svg fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v4M20 2v4M4 10h24"/>
          <rect x="6" y="12" width="20" height="16" rx="3"/>
        </svg>`,
        badge: 'Core',
        badgeType: 'core'
      },
      {
        key: 'moderation',
        title: 'Moderation',
        description: 'Advanced moderation tools including warnings, mutes, and bans',
        icon: `<svg fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>`,
        badge: 'Core',
        badgeType: 'core'
      },
      {
        key: 'utility',
        title: 'Utility Commands',
        description: 'Helpful utility commands for server management and information',
        icon: `<svg fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 12l2 2 4-4"/>
          <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z"/>
        </svg>`,
        badge: 'Core',
        badgeType: 'core'
      }
    ];

    // Initialize dashboard
    async function initDashboard() {
      if (!guildId) {
        showError('No server selected. Please return to the main dashboard and select a server.');
        return;
      }

      showLoading(true);
      
      try {
        await Promise.all([
          fetchUser(),
          fetchGuildInfo(),
          fetchModuleStates()
        ]);
        
        renderDashboard();
        setupEventListeners();
      } catch (error) {
        console.error('Dashboard initialization failed:', error);
        showError('Failed to load dashboard data. Please refresh the page.');
      } finally {
        showLoading(false);
      }
    }

    // Fetch user data
    async function fetchUser() {
      try {
        const token = localStorage.getItem('asylum_token');
        const response = await fetch('/api/user', {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch user data');
        }
        
        currentUser = await response.json();
      } catch (error) {
        console.error('Failed to fetch user:', error);
        throw error;
      }
    }

    // Fetch guild information
    async function fetchGuildInfo() {
      try {
        const response = await fetch(`/api/guild/${guildId}/info`);
        if (!response.ok) {
          throw new Error('Failed to fetch guild info');
        }
        
        currentGuild = await response.json();
      } catch (error) {
        console.error('Failed to fetch guild info:', error);
        throw error;
      }
    }

    // Fetch module states
    async function fetchModuleStates() {
      try {
        const response = await fetch(`/api/guild/${guildId}/modules`);
        if (!response.ok) {
          throw new Error('Failed to fetch module states');
        }
        
        moduleStates = await response.json();
      } catch (error) {
        console.error('Failed to fetch module states:', error);
        throw error;
      }
    }

    // Render dashboard
    function renderDashboard() {
      renderServerInfo();
      renderStats();
      renderModules();
    }

    // Render server information
    function renderServerInfo() {
      if (!currentGuild) return;

      const serverIcon = document.getElementById('serverIcon');
      const serverName = document.getElementById('serverName');
      const serverStatus = document.getElementById('serverStatus');
      const statusIndicator = document.getElementById('statusIndicator');

      if (currentGuild.icon) {
        serverIcon.src = currentGuild.icon;
        serverIcon.style.display = 'block';
      } else {
        serverIcon.style.display = 'none';
      }

              serverName.textContent = currentGuild.name || 'Dashboard';
      serverStatus.textContent = currentGuild.status || 'Online';
      
      if (currentGuild.status === 'Online') {
        statusIndicator.style.background = 'var(--accent-success)';
      } else {
        statusIndicator.style.background = 'var(--accent-danger)';
      }
    }

    // Render statistics
    function renderStats() {
      if (!currentGuild) return;

      document.getElementById('memberCount').textContent = currentGuild.memberCount || '-';
      document.getElementById('channelCount').textContent = currentGuild.channelCount || '-';
      document.getElementById('roleCount').textContent = currentGuild.roleCount || '-';
      
      const activeModules = Object.values(moduleStates).filter(Boolean).length;
      document.getElementById('moduleCount').textContent = activeModules;
    }

    // Render modules
    function renderModules() {
      const moduleGrid = document.getElementById('moduleGrid');
      const modulesGrid = document.getElementById('modulesGrid');
      
      // Clear both grids
      moduleGrid.innerHTML = '';
      modulesGrid.innerHTML = '';

      availableModules.forEach((module, index) => {
        const isEnabled = !!moduleStates[module.key];
        const card = createModuleCard(module, isEnabled, index);
        
        // Add to both grids
        moduleGrid.appendChild(card.cloneNode(true));
        modulesGrid.appendChild(card);
      });
    }

    // Create module card
    function createModuleCard(module, isEnabled, index) {
      const card = document.createElement('div');
      card.className = `module-card ${isEnabled ? 'enabled' : ''}`;
      card.style.animationDelay = `${index * 100}ms`;
      card.classList.add('animate-fade-in');

      card.innerHTML = `
        <div class="module-header">
          <div class="module-icon">
            ${module.icon}
          </div>
          <div class="module-info">
            <div class="module-title">${module.title}</div>
            <div class="module-badge">
              <span class="badge badge-${module.badgeType}">${module.badge}</span>
            </div>
          </div>
        </div>
        <div class="module-description">${module.description}</div>
        <div class="module-actions">
          <button class="module-btn ${isEnabled ? 'module-btn-secondary' : 'module-btn-primary'}" 
                  data-module="${module.key}" 
                  data-action="${isEnabled ? 'configure' : 'enable'}">
            ${isEnabled ? 'Configure' : 'Enable'}
          </button>
          ${isEnabled ? `
            <button class="module-btn module-btn-danger" 
                    data-module="${module.key}" 
                    data-action="disable">
              Disable
            </button>
          ` : ''}
        </div>
      `;

      return card;
    }

    // Setup event listeners
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', handleNavigation);
      });

      // Module buttons
      document.addEventListener('click', handleModuleAction);

      // Mobile sidebar toggle
      const sidebarToggle = document.getElementById('sidebarToggle');
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
      }

      // Close sidebar when clicking outside on mobile
      document.addEventListener('click', (e) => {
        if (window.innerWidth <= 1024) {
          const sidebar = document.getElementById('sidebar');
          const toggle = document.getElementById('sidebarToggle');
          
          if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
            sidebar.classList.remove('open');
          }
        }
      });

      // Close modal when clicking outside
      const modal = document.getElementById('disableModal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeDisableModal();
          }
        });
      }
    }

    // Handle navigation
    function handleNavigation(e) {
      e.preventDefault();
      
      const section = e.currentTarget.dataset.section;
      
      // Update active nav item
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      e.currentTarget.classList.add('active');

      // Update page content
      updatePageContent(section);
    }

    // Update page content
    function updatePageContent(section) {
      const pageTitle = document.getElementById('pageTitle');
      const pageSubtitle = document.getElementById('pageSubtitle');
      const dashboardSection = document.getElementById('dashboardSection');
      const modulesSection = document.getElementById('modulesSection');
      const helpSection = document.getElementById('helpSection');

      if (section === 'dashboard') {
        pageTitle.textContent = 'Dashboard';
        pageSubtitle.textContent = 'Server overview and quick actions';
        dashboardSection.style.display = 'block';
        modulesSection.style.display = 'none';
        helpSection.style.display = 'none';
      } else if (section === 'modules') {
        pageTitle.textContent = 'Modules';
        pageSubtitle.textContent = 'Configure your server modules';
        dashboardSection.style.display = 'none';
        modulesSection.style.display = 'block';
        helpSection.style.display = 'none';
      } else if (section === 'help') {
        pageTitle.textContent = 'Help & Support';
        pageSubtitle.textContent = 'Get help with the Dashboard';
        dashboardSection.style.display = 'none';
        modulesSection.style.display = 'none';
        helpSection.style.display = 'block';
      }
    }

    // Handle module actions
    async function handleModuleAction(e) {
      const button = e.target.closest('.module-btn');
      if (!button) return;

      const moduleKey = button.dataset.module;
      const action = button.dataset.action;

      if (action === 'enable') {
        await enableModule(moduleKey, button);
      } else if (action === 'configure') {
        configureModule(moduleKey);
      } else if (action === 'disable') {
        await disableModule(moduleKey, button);
      }
    }

    // Enable module
    async function enableModule(moduleKey, button) {
      try {
        button.disabled = true;
        button.innerHTML = '<div class="spinner"></div> Enabling...';

        const response = await fetch(`/api/guild/${guildId}/modules`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ moduleKey, enabled: true })
        });

        if (!response.ok) {
          throw new Error('Failed to enable module');
        }

        const result = await response.json();
        if (result.success) {
          moduleStates[moduleKey] = true;
          renderModules(); // Re-render to update all cards
          showSuccess(`Module enabled successfully!`);
        } else {
          throw new Error(result.error || 'Failed to enable module');
        }
      } catch (error) {
        console.error('Failed to enable module:', error);
        showError('Failed to enable module. Please try again.');
        button.disabled = false;
        button.innerHTML = 'Enable';
      }
    }

    // Configure module
    function configureModule(moduleKey) {
      window.location.href = `module.html?guild=${guildId}&module=${moduleKey}`;
    }

    // Disable module
    async function disableModule(moduleKey, button) {
      // Show custom modal instead of confirm dialog
      showDisableModal(moduleKey, button);
    }

    // Show disable confirmation modal
    function showDisableModal(moduleKey, button) {
      const modal = document.getElementById('disableModal');
      const modalText = document.getElementById('disableModalText');
      const confirmBtn = document.getElementById('confirmDisableBtn');
      
      // Find module title
      const module = availableModules.find(m => m.key === moduleKey);
      const moduleTitle = module ? module.title : moduleKey;
      
      modalText.textContent = `Are you sure you want to disable the ${moduleTitle} module?`;
      
      // Set up confirm button
      confirmBtn.onclick = () => performDisableModule(moduleKey, button);
      
      modal.style.display = 'flex';
    }

    // Close disable modal
    function closeDisableModal() {
      const modal = document.getElementById('disableModal');
      modal.style.display = 'none';
    }

    // Perform the actual module disable
    async function performDisableModule(moduleKey, button) {
      try {
        closeDisableModal();
        button.disabled = true;
        button.innerHTML = '<div class="spinner"></div> Disabling...';

        const response = await fetch(`/api/guild/${guildId}/modules`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ moduleKey, enabled: false })
        });

        if (!response.ok) {
          throw new Error('Failed to disable module');
        }

        const result = await response.json();
        if (result.success) {
          moduleStates[moduleKey] = false;
          renderModules(); // Re-render to update all cards
          showSuccess(`Module disabled successfully!`);
        } else {
          throw new Error(result.error || 'Failed to disable module');
        }
      } catch (error) {
        console.error('Failed to disable module:', error);
        showError('Failed to disable module. Please try again.');
        button.disabled = false;
        button.innerHTML = 'Disable';
      }
    }

    // Toggle mobile sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('open');
    }

    // Show loading overlay
    function showLoading(show) {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.display = show ? 'flex' : 'none';
    }

    // Show success message
    function showSuccess(message) {
      // Create a temporary success notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--accent-success);
        color: white;
        padding: var(--space-md) var(--space-lg);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        z-index: var(--z-modal);
        animation: slideIn 0.3s ease-out;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Show error message
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--accent-danger);
        color: white;
        padding: var(--space-md) var(--space-lg);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        z-index: var(--z-modal);
        animation: slideIn 0.3s ease-out;
      `;
      errorDiv.textContent = message;
      
      document.body.appendChild(errorDiv);
      
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html> 